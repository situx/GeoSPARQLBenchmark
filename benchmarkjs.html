<html>
<head>
<script src="https://code.jquery.com/jquery-3.7.0.min.js" integrity="sha256-2Pmvv0kuTBOenSvLm6bvfBSSHrUJ+3A7x6P5Ebd07/g=" crossorigin="anonymous"></script>
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js" integrity="sha256-lSjKY0/srUM9BE3dPm+c4fBo1dky2v27Gdjm2uoZaL0=" crossorigin="anonymous"></script>
<link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/colreorder/1.7.0/css/colReorder.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.dataTables.min.css">
<script src="https://cdn.datatables.net/1.13.11/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.4.1/dist/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>	
<script src="https://cdn.datatables.net/plug-ins/1.13.6/pagination/input.js"></script>
<script src="https://cdn.datatables.net/plug-ins/1.13.6/sorting/natural.js"></script>
<script src="js/gsb_10_benchmark.js"></script>
<script src="js/gsb_11_benchmark.js"></script>
<script src="js/d3sparql.js"></script>
<script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script>
var dialogeventlistener=null
var sleepparam=50
function testSPARQLEndpoint(typeproperty="http://www.w3.org/1999/02/22-rdf-syntax-ns#type",subclassproperty="http://www.w3.org/2000/01/rdf-schema#subClassOf",concept=null){
	url=$('#endpointurl').val()	
	//console.log("URL: "+url)
	d3.sparql(url, "SELECT ?a ?b ?c WHERE { ?a ?b ?c . } LIMIT 1").then((results)=>{
		$("#endpointtestresult").html("SPARQL Endpoint detected!");
	}).catch(function(e) { $("#endpointtestresult").html("Error detecting SPARQL endpoint");throw e; });
}
function sleep(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
}
async function executeAllQueries(){
	benchmarkname=$('#benchmarkversions').val()
	tabres=""
	benchmarkconfig=window[benchmarkname]
	fillTable()
	for(res in benchmarkconfig){
		executeQuery(benchmarkname,res)
		await sleep(sleepparam)
	}
	activateDataTable()
	calculateComplianceScore(benchmarkconfig)
}
function calculateComplianceScore(benchmarkconfig){
	var querycount=0
	var correctcount=0
	var compscore=0
	var moduleToScore={}
	for(res in benchmarkconfig){
		if("module" in benchmarkconfig[res] && !(benchmarkconfig[res]["module"] in moduleToScore)){
			moduleToScore[benchmarkconfig[res]["module"]]={"queries":0,"scores":0,"finalscore":0}
		}
		if("module" in benchmarkconfig[res]){
			moduleToScore[benchmarkconfig[res]["module"]]["queries"]+=1
		}		
		if("resultStatus" in benchmarkconfig[res] && benchmarkconfig[res]["resultStatus"]=="Passed"){
			correctcount+=1
			compscore+=benchmarkconfig[res]["weight"]
			if("module" in benchmarkconfig[res]){
				moduleToScore[benchmarkconfig[res]["module"]]["scores"]+=1
			}	
		}
		querycount+=1
	}
	modscorestr=""
	for(mod in moduleToScore){
		if(moduleToScore[mod]["queries"]==0){
			moduleToScore[mod]["queries"]=1
		}
		moduleToScore[mod]["finalscore"]=moduleToScore[mod]["scores"]/moduleToScore[mod]["queries"]
		modscorestr+=mod+" "+((moduleToScore[mod]["scores"]/moduleToScore[mod]["queries"])*100)+"%<br/>"
	}
	document.getElementById("correcttests").innerHTML=correctcount+"/"+querycount
	document.getElementById("compliancescore").innerHTML=(compscore*100)+"%"
	document.getElementById("compscoredialog").innerHTML=(compscore*100)+"%"
	document.getElementById("allqueriesdialog").innerHTML=correctcount+"/"+querycount
	document.getElementById("modulesscore").innerHTML=modscorestr
}

function normalizeValue(result){
	//console.log(result)
	if("results" in result && "bindings" in result["results"]){
		for(resobj of result["results"]["bindings"]){
			//console.log(resobj)
			for(res in resobj){
				if("value" in resobj[res]){
					//console.log("BINDING: "+resobj[res]["value"])
					resobj[res]["value"]=resobj[res]["value"].replace(/^\s+|\s+$/g, '');
					//console.log("BINDING: "+resobj[res]["value"])
				}
			}
		}
	}
	return result
}

function executeQuery(benchmarkname,queryid){
	url=$('#endpointurl').val()	
	benchmarkconfig=window[benchmarkname]
	if(queryid in benchmarkconfig){
		d3.sparql(url, benchmarkconfig[queryid]["query"]).then((results)=>{
			//console.log(results)
			if("message" in results){
				document.getElementById('err_'+queryid).innerHTML=results["message"];
				document.getElementById("res_"+queryid).innerHTML="Failed"
				benchmarkconfig[queryid]["error"]=results["message"]
			}else{
				sresults=JSON.stringify(results)
				if(Object.keys(benchmarkconfig[queryid]["answers"]).length>0){
					console.log(benchmarkconfig[queryid]["answers"])
					for(answer in benchmarkconfig[queryid]["answers"]){
						/*console.log(answer==sresults)
						console.log(JSON.parse(answer)==sresults)
						console.log(answer)
						console.log(sresults)
						console.log(queryid)*/
						normalizeValue(results)
						theanswer=normalizeValue(JSON.parse(answer))
						if(_.isEqual(results,theanswer)){
							document.getElementById("res_"+queryid).innerHTML="Passed"
							document.getElementById("score_"+queryid).innerHTML=document.getElementById("weight_"+queryid).innerHTML
							benchmarkconfig[queryid]["result"]=results
							benchmarkconfig[queryid]["resultStatus"]="Passed"
						}else{
							document.getElementById("res_"+queryid).innerHTML="Failed"
							document.getElementById("score_"+queryid).innerHTML="0"
							benchmarkconfig[queryid]["result"]=results
							benchmarkconfig[queryid]["resultStatus"]="Failed"
						}
					}
				}
			}
			openDialogForQuery(queryid)
		}).catch(function(e) {$('#err_'+queryid).html(e);benchmarkconfig[queryid]["error"]=e;openDialogForQuery(queryid);throw e; });	
	}
}
function fillTable(benchmarkname){
	if ($.fn.DataTable.isDataTable("#benchmarkresult")) {
	   $('#benchmarkresult').DataTable().clear().destroy();
	}
	//document.getElementById("benchmarkresultbody").innerHTML=""
	benchmarkname=$('#benchmarkversions').val()
	tabres=""
	benchmarkconfig=window[benchmarkname]
	for(res in benchmarkconfig){
		//console.log(benchmarkconfig[res])
		if(res=="score"){
			continue
		}
		tabres+="<tr><td "
		if("definition" in benchmarkconfig[res]){
			tabres+="title=\""+benchmarkconfig[res]["definition"]+"\" "
		}
		tabres+=">"
		if("label" in benchmarkconfig[res]){
			tabres+=benchmarkconfig[res]["label"]+" ("+res+") "
		}else{
			tabres+=res+" "
		}
		if("uri" in benchmarkconfig[res]){
			tabres+="<a href=\""+benchmarkconfig[res]["uri"]+"\" target=\"_blank\">&#8599;</a>"
		}
		tabres+=" <button style=\"border:0px;background-color:white\" onclick=\"openDialogForQuery('"+res+"',true)\">&#9432;</button>"
		if("module" in benchmarkconfig[res]){
			tabres+="</td><td id=\"module_"+res+"\">"+benchmarkconfig[res]["module"]
		}else{
			tabres+="</td><td id=\"module_"+res+"\">"
		}
		if("result" in benchmarkconfig[res]){
			tabres+="</td><td id=\"res_"+res+"\">"+benchmarkconfig[res]["result"]+"</td><td id=\"score_"+res+"\">"
		}else{
			tabres+="</td><td id=\"res_"+res+"\"></td><td id=\"score_"+res+"\">"
		}	
		if("weight" in benchmarkconfig[res]){
			if(benchmarkconfig[res]["result"]){
				tabres+=benchmarkconfig[res]["weight"]
			}else{
				tabres+="0"
			}
		}
		tabres+="</td><td id=\"weight_"+res+"\">"+benchmarkconfig[res]["weight"]+"</td>"
		if("err" in benchmarkconfig[res] && benchmarkconfig[res]!=""){
			tabres+="<td id=\"err_"+res+"\">"+benchmarkconfig[res]["err"]+"</td>"
		}else{
			tabres+="<td id=\"err_"+res+"\"></td>"
		}
		tabres+="<td><button id=\"test_"+res+"\" onclick=\"executeQuery('"+benchmarkname+"','"+res+"')\">Test</td>"
		tabres+="</tr>"
	}
	//console.log(tabres)
	document.getElementById("benchmarkresultbody").innerHTML=tabres
}
function fillTableProc(){
	fillTable()
	activateDataTable()
}
function activateDataTable(){
	$("#benchmarkresult").dataTable({
	paging:true,
	columnDefs:[{type:"natural",targets:"_all"}],
	"footerCallback": function ( row, data, start, end, display ) {
            var api = this.api(), data;
			$( api.column( 0 ).footer() ).html('Total');
		}
	});
}


function openDialogForQuery(queryid,showdialog=false){
	benchmarkname=$('#benchmarkversions').val()
	benchmarkconfig=window[benchmarkname]
	document.getElementById("querydialogid").innerHTML="Query "+queryid
	if("label" in benchmarkconfig[queryid]){
		document.getElementById("querydialogid").innerHTML=benchmarkconfig[queryid]["label"]
	}else{
		document.getElementById("querydialogid").innerHTML=""
	}
	if("resultStatus" in benchmarkconfig[queryid]){
		document.getElementById("querydialogstatus").innerHTML=benchmarkconfig[queryid]["resultStatus"]
	}else{
		document.getElementById("querydialogstatus").innerHTML=""
	}
	if("definition" in benchmarkconfig[queryid]){
		document.getElementById("requirementtext").innerHTML=benchmarkconfig[queryid]["definition"]
	}else{
		document.getElementById("requirementtext").innerHTML=""
	}
	if("query" in benchmarkconfig[queryid]){
		document.getElementById("querydialogquery").innerHTML=benchmarkconfig[queryid]["query"].replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll("\n","<br/>")
	}else{
		document.getElementById("querydialogquery").innerHTML=""
	}
	if("answers" in benchmarkconfig[queryid]){
		answers=""
		for(ans in benchmarkconfig[queryid]["answers"]){
			answers+=JSON.stringify(JSON.parse(ans),null,2)+"\n"
		}
		document.getElementById("querydialogexpectedresult").innerHTML=answers.replaceAll("<","&lt;").replace(">","&gt;")
	}else{
		document.getElementById("querydialogexpectedresult").innerHTML=""
	}
	if("error" in benchmarkconfig[queryid]){
		document.getElementById("querydialogretresult").innerHTML=benchmarkconfig[queryid]["error"]
	}else if("result" in benchmarkconfig[queryid] && benchmarkconfig[queryid]["result"]!=""){
		document.getElementById("querydialogretresult").innerHTML=JSON.stringify(benchmarkconfig[queryid]["result"],null,2).replaceAll("<","&lt;").replace(">","&gt;")
	}else{
		document.getElementById("querydialogretresult").innerHTML=""
	}
	document.getElementById("querydialogretestbutton").outerHTML=document.getElementById("querydialogretestbutton").outerHTML
	dialogeventlistener=document.getElementById("querydialogretestbutton").addEventListener('click', function() { executeQuery(benchmarkname,queryid);});
	if(showdialog){
		document.getElementById("queryviewdialog").showModal()
	}
}
</script>
<style>
pre {
    height: auto;
    max-height: 200px;
    overflow: auto;
    background-color: #eeeeee;
    word-break: normal !important;
    word-wrap: normal !important;
    white-space: pre !important;
}
</style>
</head>
<body>
<h1>GeoSPARQL Compliance Benchmark</h1>
<dialog id="tutorial">
<h3>GeoSPARQL Compliance Benchmark Tutorial</h3>
This tutorial helps to get you started using the JavaScript Version of the GeoSPARQL Compliance Benchmark.
<ol>
<li>Choose a SPARQL Endpoint without reasoning enabled that features the benchmark dataset for the benchmark you want to execute. A sample SPARQL endpoint is given for reference.</li>
<li>Choose a second SPARQL endpoint featuring the benchmark dataset with reasoning enabled</li>
<li>Start the testing of either all queries or selected queries to obtain benchmark results</li>
<li>Check individual query results by clicking the info icon</li>
</ol>
<button id="tutorialclosebutton" onclick="document.getElementById('tutorial').close()">Close</button>
</dialog>
<dialog id="compliancescoredialog">
<h3>Compliance Score</h1>
Score: <span id="compscoredialog"></span><br/>
Correct Queries:<span id="allqueriesdialog"></span><br/>
Modules:<br/>
<pre id="modulesscore">
</pre>
<button id="compliancescoredialogbtn" onclick="document.getElementById('compliancescoredialog').close()">Close</button>
</dialog>
<dialog id="queryviewdialog">
<h3 id="querydialogid"></h3>
<span id="requirementtext" style="font-weight:bold;"></span><br/>
Status: <span id="querydialogstatus"></span><br/>
Query:<br/>
<pre id="querydialogquery" style="background-color:#DCDCDC"></pre>
<hr>
Expected Result:<br/>
<pre id="querydialogexpectedresult" style="background-color:#DCDCDC"></pre>
<hr>
Retrieved Result:<br/>
<pre id="querydialogretresult" style="background-color:#DCDCDC"></pre>
<hr>
<button id="querydialogclosebutton" onclick="document.getElementById('queryviewdialog').close()">Close</button>
<button id="querydialogretestbutton">Re(test)</button>
</dialog>
Select Benchmark Version:
<select id="benchmarkversions" onchange="fillTableProc()">
<option value="gsb_10_benchmarkconfig">GeoSPARQL 1.0 Compliance Benchmark</option>
<option value="gsb_11_benchmarkconfig">GeoSPARQL 1.1 Compliance Benchmark</option>
</select><button id="tutorialbutton" onclick="document.getElementById('tutorial').showModal()">Tutorial</button><br/>
Endpoint URL: <input type="url" id="endpointurl" style="width:25%" value="https://api.triplydb.com/datasets/timohomburg/geosparqlbenchmark/sparql"/>
<button id="testendpoint" onclick="testSPARQLEndpoint()">Test Endpoint</button><span id="endpointtestresult"></span><br/>
Endpoint URL Reasoning: <input type="url" id="endpointurlres" style="width:25%" value="https://api.triplydb.com/datasets/timohomburg/geosparqlbenchmark/sparql"/>
<button id="testendpoint" onclick="testSPARQLEndpoint()">Test Endpoint</button><span id="endpointtestresult"></span><br/>
<button id="executetest" onclick="executeAllQueries()">Execute Test</button><br/>
Correct Tests: <span id="correcttests"></span><button style="border:0px;background-color:white" onclick="document.getElementById('compliancescoredialog').showModal()">&#9432;</button><br/>
Compliance Score: <span id="compliancescore"></span>
<table id="benchmarkresult">
<thead>
<tr><th>Query</th><th>Module</th><th>Result</th><th>Score</th><th>Weight</th><th>Error</th><th>Test</th></tr>
</thead>
<tbody id="benchmarkresultbody">

</tbody>
</table>
<script>
fillTableProc()
</script>
</body>
</html>
